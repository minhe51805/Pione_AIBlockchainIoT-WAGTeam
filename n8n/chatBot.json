{
  "name": "PioneDream",
  "nodes": [
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "16d97229-9076-4c88-bc06-76a52948c4b7",
              "name": "full_name",
              "value": "={{ $('Webhook_Zalo').item.json.body.message.from.display_name }}",
              "type": "string"
            },
            {
              "id": "dec8df0a-6acd-4469-bb28-866366672ef3",
              "name": "id_chat",
              "value": "={{ $('Webhook_Zalo').item.json.body.message.chat.id }}",
              "type": "string"
            },
            {
              "id": "14640f4f-2d13-4811-8dda-62e4713a0627",
              "name": "message",
              "value": "={{ $json.body.message.text }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1344,
        640
      ],
      "id": "ee1d6deb-8acd-483d-ab15-335b78b0c8a0",
      "name": "Edit Fields"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        1248,
        992
      ],
      "id": "d7fd1414-18cd-4f6e-ae0e-89bf3a371d40",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {
        "triggerMode": "listenTrigger",
        "channelName": "user_linked_event",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTrigger",
      "typeVersion": 1,
      "position": [
        576,
        1312
      ],
      "id": "ffab63af-5ec0-470b-b3da-12fa270102a9",
      "name": "Postgres Trigger",
      "credentials": {
        "postgres": {
          "id": "oGAHbg48Bsrkta9A",
          "name": "PieoneDream"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- X√≥a function c≈© n·∫øu c√≥\nDROP FUNCTION IF EXISTS public.notify_user_linked_event();\n\n-- 1Ô∏è‚É£ T·∫°o function\nCREATE OR REPLACE FUNCTION public.notify_user_linked_event()\nRETURNS TRIGGER AS $$\nDECLARE\n  payload JSON;\nBEGIN\n  -- Ch·ªâ k√≠ch ho·∫°t khi user ƒë∆∞·ª£c li√™n k·∫øt th√†nh c√¥ng (c√≥ zalo_chat_id m·ªõi)\n  IF (TG_OP = 'UPDATE' AND NEW.zalo_chat_id IS NOT NULL AND OLD.zalo_chat_id IS DISTINCT FROM NEW.zalo_chat_id) THEN\n    payload := json_build_object(\n      'event', 'user_linked',\n      'user_id', NEW.id,\n      'full_name', NEW.full_name,\n      'wallet_address', NEW.wallet_address,\n      'zalo_chat_id', NEW.zalo_chat_id,\n      'linked_at', now()\n    );\n\n    -- G·ª≠i th√¥ng b√°o qua k√™nh \"user_linked_event\"\n    PERFORM pg_notify('user_linked_event', payload::text);\n  END IF;\n\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- 2Ô∏è‚É£ X√≥a trigger c≈© n·∫øu c√≥\nDROP TRIGGER IF EXISTS trg_user_linked_event ON public.users;\n\n-- 3Ô∏è‚É£ T·∫°o trigger m·ªõi g·∫Øn v√†o b·∫£ng users\nCREATE TRIGGER trg_user_linked_event\nAFTER UPDATE ON public.users\nFOR EACH ROW\nEXECUTE FUNCTION public.notify_user_linked_event();\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        560,
        288
      ],
      "id": "38009d93-e757-4b92-a74a-3a1982ad4e12",
      "name": "trigger user_contact_update",
      "credentials": {
        "postgres": {
          "id": "oGAHbg48Bsrkta9A",
          "name": "PieoneDream"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=C√¢u h·ªèi c·ªßa ng∆∞·ªùi d√πng:\n\"{{ $('Webhook_Zalo').item.json.body.message.text }}\"\nV·ªõi c√°c th√¥ng ng∆∞·ªùi d√πng:\nH·ªç T√™n: {{ $('Webhook_Zalo').item.json.body.message.from.display_name }}\nId: {{ $json.id }}\nwallet_address: {{ $json.wallet_address }}",
        "options": {
          "systemMessage": "=üéØ Vai tr√≤ c·ªßa b·∫°n:\nB·∫°n l√† **GAIA.VN AI Agent**, tr·ª£ l√Ω n√¥ng nghi·ªáp th√¥ng minh c·ªßa n·ªÅn t·∫£ng DApp GAIA.VN.  \nB·∫°n c√≥ kh·∫£ nƒÉng:\n1Ô∏è‚É£ Tr·∫£ l·ªùi c√°c c√¢u h·ªèi l√Ω thuy·∫øt, k·ªπ nƒÉng, v√† ki·∫øn th·ª©c n√¥ng nghi·ªáp (ƒë·∫•t, n∆∞·ªõc, c√¢y tr·ªìng, dinh d∆∞·ª°ng, canh t√°c, m√¥i tr∆∞·ªùng, IoT, AI, blockchain,...).  \n2Ô∏è‚É£ G·ªçi c√¥ng c·ª• **User Lookup** ƒë·ªÉ tra c·ª©u th√¥ng tin ng∆∞·ªùi d√πng hi·ªán t·∫°i (v√≠ d·ª•: v√≠ blockchain, ID thi·∫øt b·ªã, v·ªã tr√≠ canh t√°c, h·ªç t√™n...).  \n3Ô∏è‚É£ G·ªçi c√¥ng c·ª• **Data Query** ƒë·ªÉ truy xu·∫•t d·ªØ li·ªáu c·∫£m bi·∫øn, ph√¢n t√≠ch AI, ho·∫∑c log blockchain c·ªßa ng∆∞·ªùi d√πng.  \n\n---\n\n### üß© C√°ch ra quy·∫øt ƒë·ªãnh:\n\n**N·∫øu c√¢u h·ªèi thu·ªôc nh√≥m l√Ω thuy·∫øt ho·∫∑c ki·∫øn th·ª©c chung**  \n‚Üí Kh√¥ng c·∫ßn d√πng tool n√†o.  \n‚Üí Tr·∫£ l·ªùi tr·ª±c ti·∫øp b·∫±ng ki·∫øn th·ª©c c·ªßa b·∫°n (ng·∫Øn g·ªçn, d·ªÖ hi·ªÉu, c√≥ v√≠ d·ª• th·ª±c t·∫ø).\n\n**N·∫øu c√¢u h·ªèi y√™u c·∫ßu th√¥ng tin c√° nh√¢n ho·∫∑c d·ªØ li·ªáu ng∆∞·ªùi d√πng**  \n(v√≠ d·ª•: ‚ÄúT√¥i l√† ai?‚Äù, ‚ÄúV√≠ c·ªßa t√¥i l√† g√¨?‚Äù, ‚ÄúThi·∫øt b·ªã c·ªßa t√¥i ID bao nhi√™u?‚Äù)  \n‚Üí G·ªçi **User Lookup Tool**.  \n‚Üí Sau khi nh·∫≠n k·∫øt qu·∫£, t√≥m t·∫Øt v√† tr·∫£ l·ªùi th√¢n thi·ªán.  \n\n**N·∫øu c√¢u h·ªèi li√™n quan ƒë·∫øn d·ªØ li·ªáu th·ª±c t·∫ø**  \n(v√≠ d·ª•: ‚ÄúCh·∫•t l∆∞·ª£ng n∆∞·ªõc h√¥m nay sao?‚Äù, ‚ÄúAI d·ª± ƒëo√°n c√¢y tr·ªìng t√¥i th·∫ø n√†o?‚Äù,  \n‚ÄúD·ªØ li·ªáu IoT c·ªßa t√¥i g·∫ßn nh·∫•t l√† g√¨?‚Äù, ‚ÄúD·ªØ li·ªáu ƒë√£ l√™n blockchain ch∆∞a?‚Äù)  \n‚Üí G·ªçi **Data Query Tool**.  \n‚Üí Sau khi nh·∫≠n d·ªØ li·ªáu, di·ªÖn gi·∫£i √Ω nghƒ©a, c·∫£nh b√°o n·∫øu b·∫•t th∆∞·ªùng,  \nv√† th√™m nh·∫≠n x√©t ho·∫∑c l·ªùi khuy√™n n√¥ng nghi·ªáp ph√π h·ª£p.\n\n---\n\n### üìò H∆∞·ªõng d·∫´n tr·∫£ l·ªùi:\n- Tr·∫£ l·ªùi b·∫±ng **ti·∫øng Vi·ªát t·ª± nhi√™n**, th√¢n thi·ªán v√† d·ªÖ hi·ªÉu.  \n- N·∫øu d·ªØ li·ªáu c√≥ v·∫•n ƒë·ªÅ (pH < 5.5, ƒë·ªô m·∫∑n > 1.0‚Ä∞, AI score < 6) ‚Üí ƒë∆∞a **c·∫£nh b√°o nh·∫π nh√†ng** v√† **h∆∞·ªõng d·∫´n x·ª≠ l√Ω**.  \n- N·∫øu d·ªØ li·ªáu t·ªët ‚Üí ƒë∆∞a l·ªùi kh√≠ch l·ªá (‚Äúr·∫•t t·ªët‚Äù, ‚Äú·ªïn ƒë·ªãnh‚Äù, ‚Äúduy tr√¨ nh∆∞ v·∫≠y nh√© üåø‚Äù).  \n- Th√™m m·ªôt √≠t icon cho t·ª± nhi√™n v√† ƒë·ªãnh d·∫°ng ch·ªØ th∆∞·ªùng kh√¥ng c·∫ßn in ƒë·∫≠m,ngang,...\n- N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu, tr·∫£ l·ªùi: ‚ÄúHi·ªán t·∫°i h·ªá th·ªëng ch∆∞a ghi nh·∫≠n d·ªØ li·ªáu c·ªßa b·∫°n.‚Äù  \n- N·∫øu ng∆∞·ªùi d√πng h·ªèi ngo√†i ph·∫°m vi (v√≠ d·ª• ch√≠nh tr·ªã, t√¥n gi√°o), h√£y n√≥i l·ªãch s·ª±: ‚ÄúT√¥i ch·ªâ h·ªó tr·ª£ c√°c v·∫•n ƒë·ªÅ n√¥ng nghi·ªáp v√† d·ªØ li·ªáu m√¥i tr∆∞·ªùng.‚Äù  \n\n---\n\n### ‚öôÔ∏è C·∫•u tr√∫c logic:\n\n1Ô∏è‚É£ Hi·ªÉu c√¢u h·ªèi c·ªßa ng∆∞·ªùi d√πng  \n2Ô∏è‚É£ Quy·∫øt ƒë·ªãnh: **Chat b√¨nh th∆∞·ªùng / G·ªçi User Lookup / G·ªçi Data Query**  \n3Ô∏è‚É£ N·∫øu g·ªçi tool ‚Üí ƒë·ª£i k·∫øt qu·∫£ ‚Üí ph√¢n t√≠ch ‚Üí tr·∫£ l·ªùi  \n4Ô∏è‚É£ N·∫øu kh√¥ng c·∫ßn tool ‚Üí tr·∫£ l·ªùi tr·ª±c ti·∫øp  \n\n---\n\n### üß† M·ª•c ti√™u cu·ªëi:\nT·∫°o tr·∫£i nghi·ªám t·ª± nhi√™n nh∆∞ m·ªôt **chuy√™n gia n√¥ng nghi·ªáp ·∫£o**,  \nnh∆∞ng v·∫´n bi·∫øt c√°ch **truy xu·∫•t d·ªØ li·ªáu th·∫≠t c·ªßa ng∆∞·ªùi d√πng** khi c·∫ßn.  \nLu√¥n ƒë·∫£m b·∫£o ƒë·ªô ch√≠nh x√°c, r√µ r√†ng v√† th√¢n thi·ªán.\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        2416,
        256
      ],
      "id": "e7c0cc62-ec74-4f72-ba09-503e6d729d93",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        2304,
        464
      ],
      "id": "6dfa59e4-6d8c-4e5b-9bfc-3f212294b5f7",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "Iv88COAz0eeDSz5C",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "content": "## Trigger th√¥ng b√°o li√™n k·∫øt t√†i kho·∫£n zalo th√†nh c√¥ng\n",
        "height": 304,
        "width": 1296
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        480,
        1216
      ],
      "typeVersion": 1,
      "id": "696fce10-7674-49fc-ab3f-80e666e9a9a5",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "multipleMethods": true,
        "httpMethod": [
          "POST"
        ],
        "path": "chat-zalo",
        "responseMode": "lastNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        544,
        752
      ],
      "id": "bfe6cc8c-d75a-4ddb-a547-ef666be1cf27",
      "name": "Webhook_Zalo",
      "webhookId": "9703b97b-bbff-4c18-b50c-c457ea64ca90"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zapps.me/bot2636990041745555077:sIBMRsWMvGYeFkBOgbNBuFglputEIxZtlVdRIeByFyZDfpFmaduLvoWPTpmMFcxT/setWebhook",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "url",
              "value": "http://36.50.135.18/webhook/chat-zalo"
            },
            {
              "name": "secret_token",
              "value": "ttadz123"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1232,
        304
      ],
      "id": "3a1a374b-9226-4745-bc33-8ce069592ab5",
      "name": "SetWebHook"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zapps.me/bot2636990041745555077:sIBMRsWMvGYeFkBOgbNBuFglputEIxZtlVdRIeByFyZDfpFmaduLvoWPTpmMFcxT/deleteWebhook",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {}
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1040,
        304
      ],
      "id": "cf4f8894-0df9-4c9a-bbd8-ffa4f19f8287",
      "name": "DeleteWebHook"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT event_object_table, trigger_name, action_timing, event_manipulation, action_statement\nFROM information_schema.triggers\nWHERE event_object_table = 'users';\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        768,
        304
      ],
      "id": "73563e17-1872-41be-8d1f-d8578f7f7031",
      "name": "Execute a SQL query",
      "credentials": {
        "postgres": {
          "id": "oGAHbg48Bsrkta9A",
          "name": "PieoneDream"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "users",
          "mode": "list",
          "cachedResultName": "users"
        },
        "where": {
          "values": [
            {
              "column": "id",
              "value": "={{ $('L·∫•y th√¥ng tin User').item.json.id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        2624,
        496
      ],
      "id": "9f5ac789-9bae-41e0-8402-054ff3fedf93",
      "name": "User Lookup",
      "credentials": {
        "postgres": {
          "id": "oGAHbg48Bsrkta9A",
          "name": "PieoneDream"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "sensor_readings",
          "mode": "list",
          "cachedResultName": "sensor_readings"
        },
        "limit": 5,
        "sort": {
          "values": [
            {
              "column": "measured_at_vn",
              "direction": "DESC"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        2736,
        464
      ],
      "id": "616317ca-730f-4c91-a19f-bc579e934852",
      "name": "Data Query",
      "credentials": {
        "postgres": {
          "id": "oGAHbg48Bsrkta9A",
          "name": "PieoneDream"
        }
      }
    },
    {
      "parameters": {
        "content": "## Trigger g·ª≠i b√°o c√°o 20h h·∫±ng ng√†y \n",
        "height": 448,
        "width": 2144
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        480,
        1552
      ],
      "typeVersion": 1,
      "id": "a466a9e2-99cd-49c1-a2e1-11af1da74c8c",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "triggerAtHour": 20
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        528,
        1728
      ],
      "id": "cb28e256-0564-41e7-8593-9e41e808a9d8",
      "name": "Schedule Trigger"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash"
        },
        "messages": {
          "values": [
            {
              "content": "=üåæ B·∫°n l√† tr·ª£ l√Ω GAIA.VN AI n√¥ng nghi·ªáp th√¥ng minh.\n\nD∆∞·ªõi ƒë√¢y l√† d·ªØ li·ªáu trung b√¨nh c·∫£m bi·∫øn c·ªßa ng√†y h√¥m nay:\n{{ JSON.stringify($json, null, 2) }}\n\n\nH√£y vi·∫øt m·ªôt **b·∫£n b√°o c√°o ng·∫Øn g·ªçn, d·ªÖ hi·ªÉu (4‚Äì6 c√¢u)** b·∫±ng ti·∫øng Vi·ªát,\nd√†nh cho ng∆∞·ªùi n√¥ng d√¢n (kh√¥ng k·ªπ thu·∫≠t, kh√¥ng li·ªát k√™ s·ªë li·ªáu d·∫°ng b·∫£ng).\n\nY√™u c·∫ßu:\n1Ô∏è‚É£ M·ªü ƒë·∫ßu b·∫±ng ng√†y h√¥m nay (v√≠ d·ª•: \"üìÖ B√°o c√°o ng√†y 4/11/2025:\") - n·∫øu kh√¥ng c√≥ th√¨ d·ªØ li·ªáu th√¨ n√≥i kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu n√†o....\n2Ô∏è‚É£ T√≥m t·∫Øt t√¨nh h√¨nh:\n   - Nhi·ªát ƒë·ªô ƒë·∫•t & kh√¥ng kh√≠ (m√°t, n√≥ng, ·ªïn ƒë·ªãnh)\n   - ƒê·ªô ·∫©m ƒë·∫•t & kh√¥ng kh√≠ (ƒë·ªß, thi·∫øu, cao)\n   - pH ƒë·∫•t (trung t√≠nh, chua, ki·ªÅm)\n   - T√¨nh h√¨nh m∆∞a h√¥m nay (n·∫øu c√≥)\n3Ô∏è‚É£ ƒê∆∞a ra ƒë√°nh gi√° t·ªïng quan v·ªÅ **s·ª©c kh·ªèe ƒë·∫•t** v√† **m√¥i tr∆∞·ªùng tr·ªìng tr·ªçt** h√¥m nay.\n4Ô∏è‚É£ N·∫øu c√≥ d·∫•u hi·ªáu b·∫•t th∆∞·ªùng (v√≠ d·ª• pH th·∫•p, ƒë·∫•t kh√¥, n√≥ng qu√°), h√£y th√™m c·∫£nh b√°o ng·∫Øn.\n5Ô∏è‚É£ Th√™m **g·ª£i √Ω cho ng√†y mai**: \n   - N√™n l√†m g√¨ (t∆∞·ªõi th√™m, ki·ªÉm tra pH, ngh·ªâ t∆∞·ªõi, b√≥n ph√¢n nh·∫π, v.v.)\n6Ô∏è‚É£ K·∫øt th√∫c b·∫±ng l·ªùi kh√≠ch l·ªá t√≠ch c·ª±c, v√≠ d·ª•:\n   ‚ÄúC·∫£m ∆°n b·∫°n ƒë√£ ƒë·ªìng h√†nh c√πng h·ªá th·ªëng AI N√¥ng Nghi·ªáp Th√¥ng Minh üå±.‚Äù\n\nVi·∫øt th√†nh t·ª± nhi√™n, th√¢n thi·ªán, v√† truy·ªÅn c·∫£m h·ª©ng.\nKh√¥ng c·∫ßn hi·ªÉn th·ªã s·ªë c·ª• th·ªÉ, h√£y di·ªÖn ƒë·∫°t c·∫£m nh·∫≠n t·ªïng qu√°t.\n"
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        1040,
        1728
      ],
      "id": "40b2b498-47cc-471c-9d0c-b45018d183e3",
      "name": "Message a model",
      "credentials": {
        "googlePalmApi": {
          "id": "Iv88COAz0eeDSz5C",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        1648,
        1680
      ],
      "id": "497c53fb-fa92-4b15-8c28-03a30611eacd",
      "name": "Loop Over Items"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "name": "Replace Me",
      "typeVersion": 1,
      "position": [
        2368,
        1808
      ],
      "id": "81c095cb-0390-4ae6-aba4-f8ffeba65522"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        1984,
        1568
      ],
      "id": "718f4c6c-1af8-4370-a192-c3b601bcfdd8",
      "name": "No Operation, do nothing1"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.zalo_chat_id }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        2464,
        480
      ],
      "id": "252e82fd-0b8d-49d5-84ab-48b828bb84cc",
      "name": "Postgres Chat Memory",
      "credentials": {
        "postgres": {
          "id": "oGAHbg48Bsrkta9A",
          "name": "PieoneDream"
        }
      }
    },
    {
      "parameters": {
        "content": "## Chat",
        "height": 480,
        "width": 1184,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2176,
        176
      ],
      "typeVersion": 1,
      "id": "fc21c267-aa19-45cb-b40c-cce650eeabe2",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "## Li√™n K·∫øt",
        "height": 512,
        "width": 1184,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2176,
        784
      ],
      "typeVersion": 1,
      "id": "04ee4854-33a4-4e39-858e-a4ab0d7543ae",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zapps.me/bot2636990041745555077:sIBMRsWMvGYeFkBOgbNBuFglputEIxZtlVdRIeByFyZDfpFmaduLvoWPTpmMFcxT/sendChatAction",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $json.body.message.chat.id }}"
            },
            {
              "name": "action",
              "value": "typing"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        832,
        768
      ],
      "id": "35a7c463-8e68-4a10-b3a2-7c6de12c7723",
      "name": "sendChatAction"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "c082f5ab-4ca8-4c0c-bf2e-b137ce7eee9a",
              "leftValue": "={{ $json.body.message.message_type }}",
              "rightValue": "PRIVATE",
              "operator": {
                "type": "string",
                "operation": "notExists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1056,
        736
      ],
      "id": "5aff1ff2-6ed8-4ad4-ba5b-2fc0d91e3aef",
      "name": "Ki·ªÉm tra input"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n    id,\n    full_name,\n    email,\n    wallet_address,\n    zalo_chat_id,\n    'Found user' AS result\nFROM public.users\nWHERE zalo_chat_id = '{{ $json.id_chat }}'\n\nUNION ALL\n\nSELECT \n    NULL AS id,\n    NULL AS full_name,\n    NULL AS email,\n    NULL AS wallet_address,\n    'null' AS zalo_chat_id,\n    'No user found' AS result\nWHERE NOT EXISTS (\n    SELECT 1 FROM public.users WHERE zalo_chat_id = '{{ $json.id_chat }}'\n);\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1664,
        704
      ],
      "id": "3078a701-a5f1-452d-82ce-1dfc86f9bfa4",
      "name": "L·∫•y th√¥ng tin User",
      "credentials": {
        "postgres": {
          "id": "oGAHbg48Bsrkta9A",
          "name": "PieoneDream"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "fb587806-ad80-43c9-8bc4-b82e81d13cae",
              "leftValue": "={{ $json.result }}",
              "rightValue": "Found user",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1936,
        688
      ],
      "id": "58220294-0701-4576-b951-9cd22729fdf8",
      "name": "Ki·ªÉm tra user li√™n k·∫øt t√†i kho·∫£n"
    },
    {
      "parameters": {
        "content": "## Zalo chatbot",
        "height": 608,
        "width": 1648,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        496,
        528
      ],
      "typeVersion": 1,
      "id": "e82504b6-1ab6-4104-ac92-2e60d0216232",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "zalo_link_sessions",
          "mode": "list",
          "cachedResultName": "zalo_link_sessions"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "token": "={{ $json.token }}",
            "user_id": 0,
            "zalo_id": "={{ $json.zalo_id }}",
            "expires_at": "={{ $json.expiresAt }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "zalo_id",
              "displayName": "zalo_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "token",
              "displayName": "token",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "expires_at",
              "displayName": "expires_at",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "is_used",
              "displayName": "is_used",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2704,
        1008
      ],
      "id": "7c654c8f-4b10-4703-8501-2a9f0ca35e32",
      "name": "T·∫°o token session",
      "credentials": {
        "postgres": {
          "id": "oGAHbg48Bsrkta9A",
          "name": "PieoneDream"
        }
      }
    },
    {
      "parameters": {
        "action": "generate",
        "encodingType": "base64"
      },
      "type": "n8n-nodes-base.crypto",
      "typeVersion": 1,
      "position": [
        2272,
        992
      ],
      "id": "1e6d135e-5fcf-466b-866c-b4fad0ab149d",
      "name": "T·∫°o Token"
    },
    {
      "parameters": {
        "jsCode": "const zalo_id = $('Edit Fields').first().json.id_chat;\nconst token = $input.first().json.data; \nconst expiresAt = new Date(Date.now() + 5 * 60 * 1000).toISOString();\n\nreturn [{ json: { token, zalo_id, expiresAt } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2496,
        1024
      ],
      "id": "2f63bc27-54e2-4368-b733-29b8389c3f4e",
      "name": "X·ª≠ l√Ω d·ªØ li·ªáu"
    },
    {
      "parameters": {
        "jsCode": "const body = {\n  recipient: {\n    id: $input.first().json.zalo_id\n  },\n  message: {\n    text:\n      \"üåæ Xin ch√†o \" + $('Edit Fields').first().json.full_name + \" !\\n\\n\" +\n      \"ƒê·ªÉ ho√†n t·∫•t x√°c minh v√† li√™n k·∫øt t√†i kho·∫£n c·ªßa b·∫°n v·ªõi h·ªá th·ªëng, vui l√≤ng b·∫•m v√†o li√™n k·∫øt d∆∞·ªõi ƒë√¢y:\\n\\n\" +\n      \"üîó \" + \"https://163-61-183-90.nip.io/linkaccount?token=\" + $input.first().json.token + \"\\n\\n\" +\n      \"‚è∞ L∆∞u √Ω: Li√™n k·∫øt n√†y ch·ªâ c√≥ hi·ªáu l·ª±c trong 5 ph√∫t ƒë·ªÉ ƒë·∫£m b·∫£o an to√†n. Sau th·ªùi gian n√†y, b·∫°n c·∫ßn y√™u c·∫ßu li√™n k·∫øt l·∫°i.\\n\\n\" +\n      \"C·∫£m ∆°n b·∫°n ƒë√£ tin t∆∞·ªüng v√† s·ª≠ d·ª•ng h·ªá th·ªëng c·ªßa ch√∫ng t√¥i üíö\"\n  }\n};\n\nreturn [{ data: body }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2944,
        992
      ],
      "id": "6fc36f48-9e4c-4f09-a0f4-ebb32441922e",
      "name": "T·∫°o tin nh·∫Øn li√™n k·∫øt"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zapps.me/bot2636990041745555077:sIBMRsWMvGYeFkBOgbNBuFglputEIxZtlVdRIeByFyZDfpFmaduLvoWPTpmMFcxT/sendMessage",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "=chat_id",
              "value": "={{ $('Ki·ªÉm tra user li√™n k·∫øt t√†i kho·∫£n').item.json.zalo_chat_id }}"
            },
            {
              "name": "text",
              "value": "={{ $json.output }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3168,
        288
      ],
      "id": "39fef5b2-22ef-452d-a031-fedf3c15705a",
      "name": "sendMessage_Chat"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zapps.me/bot2636990041745555077:sIBMRsWMvGYeFkBOgbNBuFglputEIxZtlVdRIeByFyZDfpFmaduLvoWPTpmMFcxT/sendMessage",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $json.data.recipient.id }}"
            },
            {
              "name": "text",
              "value": "={{ $json.data.message.text }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3184,
        1008
      ],
      "id": "e47bf10c-7f8d-4b6b-83d1-9028e2aa347b",
      "name": "sendMessage_Link"
    },
    {
      "parameters": {
        "jsCode": "// L·∫•y d·ªØ li·ªáu t·ª´ payload c·ªßa trigger\nconst data = $json.payload || $json;\n\n// Format gi·ªù Vi·ªát Nam (n·∫øu c·∫ßn d√πng)\nconst date = new Date(data.linked_at);\nconst linkedAtVN = date.toLocaleString('vi-VN', { timeZone: 'Asia/Ho_Chi_Minh' });\n\n// Tin nh·∫Øn ch√†o m·ª´ng\nconst message = `\nüåæ *Xin ch√†o ${data.full_name}!*\n\nüéâ B·∫°n ƒë√£ *li√™n k·∫øt th√†nh c√¥ng* t√†i kho·∫£n v·ªõi h·ªá th·ªëng *AI N√¥ng Nghi·ªáp Th√¥ng Minh*.\n\nT·ª´ b√¢y gi·ªù, b·∫°n c√≥ th·ªÉ:\n- üìä Theo d√µi d·ªØ li·ªáu IoT t·ª´ c·∫£m bi·∫øn ƒë·∫•t, nhi·ªát ƒë·ªô, ƒë·ªô ·∫©m, m∆∞a...\n- ü§ñ Nh·∫≠n ph√¢n t√≠ch v√† khuy·∫øn ngh·ªã t·ª´ AI gi√∫p c·∫£i thi·ªán nƒÉng su·∫•t c√¢y tr·ªìng.\n- üîó L∆∞u tr·ªØ d·ªØ li·ªáu minh b·∫°ch tr√™n *Zero Blockchain* ‚Äî ƒë·∫£m b·∫£o an to√†n v√† kh√¥ng th·ªÉ b·ªã s·ª≠a ƒë·ªïi.\n- üì± Truy c·∫≠p tr·ª±c ti·∫øp DApp ƒë·ªÉ xem bi·ªÉu ƒë·ªì, d·ª± b√°o v√† t∆∞ v·∫•n canh t√°c.\n\nC·∫£m ∆°n b·∫°n ƒë√£ tin t∆∞·ªüng ƒë·ªìng h√†nh c√πng ch√∫ng t√¥i!  \nüíö Ch√∫c b·∫°n m·ªôt m√πa v·ª• b·ªôi thu v√† canh t√°c hi·ªáu qu·∫£ c√πng c√¥ng ngh·ªá üå±\n`;\n\n// Tr·∫£ output cho node k·∫ø ti·∫øp (g·ª≠i Zalo, Telegram, Discord,...)\nreturn [{\n  json: {\n    message,\n    full_name: data.full_name,\n    linked_at: linkedAtVN\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        992,
        1344
      ],
      "id": "c260886f-d78f-48cf-b91b-824e06768e54",
      "name": "T·∫°o tin nh·∫Øn li√™n k·∫øt th√†nh c√¥ng"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zapps.me/bot2636990041745555077:sIBMRsWMvGYeFkBOgbNBuFglputEIxZtlVdRIeByFyZDfpFmaduLvoWPTpmMFcxT/sendMessage",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $('Postgres Trigger').item.json.payload.zalo_chat_id }}"
            },
            {
              "name": "text",
              "value": "={{ $json.message }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1504,
        1280
      ],
      "id": "4aa616f6-b0d0-4a9c-b7db-39eb916c85a9",
      "name": "sendMessage_linksuccess"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://163-61-183-90.nip.io/api/ai/analyze-daily-insights",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        784,
        1776
      ],
      "id": "e79d53a3-9ac6-4835-bc97-5dffaea493f6",
      "name": "Analyze_Daily_Insights"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "users",
          "mode": "list",
          "cachedResultName": "users"
        },
        "where": {
          "values": [
            {
              "column": "zalo_chat_id",
              "condition": "IS NOT NULL"
            }
          ]
        },
        "options": {
          "outputColumns": [
            "full_name",
            "farm_name",
            "email",
            "zalo_chat_id"
          ]
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1408,
        1696
      ],
      "id": "9e677fde-0fe3-4d37-b3f6-3086a24c2dfd",
      "name": "L·∫•y zalo id",
      "credentials": {
        "postgres": {
          "id": "oGAHbg48Bsrkta9A",
          "name": "PieoneDream"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zapps.me/bot2636990041745555077:sIBMRsWMvGYeFkBOgbNBuFglputEIxZtlVdRIeByFyZDfpFmaduLvoWPTpmMFcxT/sendMessage",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $json.zalo_chat_id }}"
            },
            {
              "name": "text",
              "value": "={{ $('Message a model').item.json.content.parts[0].text }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1984,
        1760
      ],
      "id": "a374dd52-7165-4883-a159-816af7d914c3",
      "name": "sendMessage_report",
      "onError": "continueRegularOutput"
    }
  ],
  "pinData": {},
  "connections": {
    "Edit Fields": {
      "main": [
        [
          {
            "node": "L·∫•y th√¥ng tin User",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Trigger": {
      "main": [
        [
          {
            "node": "T·∫°o tin nh·∫Øn li√™n k·∫øt th√†nh c√¥ng",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "sendMessage_Chat",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Webhook_Zalo": {
      "main": [
        [
          {
            "node": "sendChatAction",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "trigger user_contact_update": {
      "main": [
        []
      ]
    },
    "User Lookup": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Data Query": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Analyze_Daily_Insights",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message a model": {
      "main": [
        [
          {
            "node": "L·∫•y zalo id",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [
          {
            "node": "No Operation, do nothing1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "sendMessage_report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Replace Me": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "sendChatAction": {
      "main": [
        [
          {
            "node": "Ki·ªÉm tra input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ki·ªÉm tra input": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "L·∫•y th√¥ng tin User": {
      "main": [
        [
          {
            "node": "Ki·ªÉm tra user li√™n k·∫øt t√†i kho·∫£n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ki·ªÉm tra user li√™n k·∫øt t√†i kho·∫£n": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "T·∫°o Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "T·∫°o token session": {
      "main": [
        [
          {
            "node": "T·∫°o tin nh·∫Øn li√™n k·∫øt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "T·∫°o Token": {
      "main": [
        [
          {
            "node": "X·ª≠ l√Ω d·ªØ li·ªáu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "X·ª≠ l√Ω d·ªØ li·ªáu": {
      "main": [
        [
          {
            "node": "T·∫°o token session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "T·∫°o tin nh·∫Øn li√™n k·∫øt": {
      "main": [
        [
          {
            "node": "sendMessage_Link",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "T·∫°o tin nh·∫Øn li√™n k·∫øt th√†nh c√¥ng": {
      "main": [
        [
          {
            "node": "sendMessage_linksuccess",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze_Daily_Insights": {
      "main": [
        [
          {
            "node": "Message a model",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "L·∫•y zalo id": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "sendMessage_report": {
      "main": [
        [
          {
            "node": "Replace Me",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "1UGVnWBRTYUpHbXy"
  },
  "versionId": "4b08c0ac-1481-4424-963d-2bb6ad53c984",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "4ba99ef3aa2bc0b02c1798cad539a452ee8bd906dbca461afb9fd7ea8f6f3a04"
  },
  "id": "1UGVnWBRTYUpHbXy",
  "tags": []
}